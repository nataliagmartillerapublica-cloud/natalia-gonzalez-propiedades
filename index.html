<!--
  @file index.html
  @description NGespacios ‚Äî Sitio p√∫blico. Carga propiedades desde Google Sheets (CSV), 
               incluye buscador funcional y galer√≠a. Sin panel Admin embebido.
               Anti-badge para ocultar cualquier overlay de Vercel o similares.
-->

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />

    <title>NGespacios ‚Äî Inmobiliaria en Bariloche</title>
    <meta
      name="description"
      content="Venta, alquiler, tasaciones y acompa√±amiento personalizado en Bariloche."
    />
    <meta name="theme-color" content="#572d30" />

    <!-- Open Graph -->
    <meta property="og:title" content="NGespacios ‚Äî Inmobiliaria en Bariloche" />
    <meta
      property="og:description"
      content="Venta, alquiler, tasaciones y acompa√±amiento personalizado en Bariloche."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:image"
      content="https://pub-cdn.sider.ai/u/U0Z6H6GX0R3/web-coder/68bc90b5d4f5bb9dcd3b8249/resource/ea65a1b8-690c-4544-909e-d44a40ea8675.jpg"
    />

    <!-- Fuente -->
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Estilos de marca y accesibilidad -->
    <style>
      :root {
        --brand-bg: #f4f2f2;
        --brand-primary: #572d30;
        --brand-text: #363332;
      }
      html, body { height: 100%; }
      body {
        font-family: 'Montserrat', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        color: var(--brand-text);
        background: var(--brand-bg);
        font-weight: 300;
        letter-spacing: 0.01em;
      }
      a:focus-visible, button:focus-visible, select:focus-visible, input:focus-visible, textarea:focus-visible {
        outline: 2px solid var(--brand-primary);
        outline-offset: 2px;
        border-radius: 6px;
      }
      /* Contenedor ancho m√°ximo similar al proyecto */
      .container-max { max-width: 72rem; } /* ~6xl */
      /* Utilidad para ocultar la barra de scroll dentro del carrusel en algunos navegadores */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Anti-badge (oculta cualquier logo/bot√≥n/overlay inyectado del hosting: Vercel/insights) */
      a[href*="vercel.com"],
      a[href*="vercel.app"],
      [aria-label*="Vercel" i],
      [aria-label*="vercel" i],
      [data-vercel-insights],
      [data-vercel-analytics],
      [data-ai-insights],
      [data-nextjs-toast],
      [data-vc],
      [data-vercel-banner],
      img[alt*="vercel" i],
      iframe[src*="vercel" i],
      .vercel-badge,
      #vercel,
      #__vercel {
        display: none !important;
        visibility: hidden !important;
        pointer-events: none !important;
        width: 0 !important;
        height: 0 !important;
        opacity: 0 !important;
      }
    </style>
  </head>

  <body class="min-h-screen bg-[color:var(--brand-bg)] text-[color:var(--brand-text)]">
    <!-- Header -->
    <header class="sticky top-0 z-30 w-full border-b border-neutral-200 bg-[color:var(--brand-bg)]/90 backdrop-blur-md">
      <div class="mx-auto container-max px-4 h-16 flex items-center justify-between">
        <a href="#" class="flex items-center gap-2" aria-label="NGespacios - Inicio">
          <!-- Logo horizontal: cuadrado ‚ÄúNG‚Äù + texto ESPACIOS a la derecha -->
          <div class="h-9 w-9 md:h-10 md:w-10 rounded-[8px] bg-[color:var(--brand-primary)] grid place-items-center shadow-sm">
            <span class="text-[color:var(--brand-bg)] font-light tracking-tight text-[15px] md:text-[16px]">NG</span>
          </div>
          <span class="text-[12px] md:text-sm tracking-[0.22em] text-[color:var(--brand-text)] font-light uppercase">
            ESPACIOS
          </span>
        </a>

        <nav class="hidden md:flex items-center gap-6 text-sm">
          <a href="#propiedades" class="hover:text-[color:var(--brand-primary)]">Propiedades</a>
          <a href="#tasacion" class="hover:text-[color:var(--brand-primary)]">Tasaci√≥n</a>
          <a href="#contacto" class="hover:text-[color:var(--brand-primary)]">Contacto</a>
          <a
            href="#propiedades"
            class="rounded-lg bg-[color:var(--brand-primary)] px-4 py-2 text-white hover:opacity-90 transition-colors"
          >
            Ver propiedades
          </a>
        </nav>

        <button
          id="btn-mobile"
          class="md:hidden inline-flex h-9 w-9 items-center justify-center rounded-md border border-neutral-300"
          aria-label="Abrir men√∫"
          aria-expanded="false"
          aria-controls="mobile-menu"
          type="button"
        >
          <i data-lucide="menu" class="h-4 w-4"></i>
        </button>
      </div>

      <!-- Men√∫ m√≥vil -->
      <div id="mobile-menu" class="md:hidden hidden border-t border-neutral-200 bg-[color:var(--brand-bg)]/95 backdrop-blur-md">
        <div class="mx-auto container-max px-4 py-3">
          <div class="grid gap-2 text-sm">
            <a href="#propiedades" class="py-2 hover:text-[color:var(--brand-primary)]">Propiedades</a>
            <a href="#tasacion" class="py-2 hover:text-[color:var(--brand-primary)]">Tasaci√≥n</a>
            <a href="#contacto" class="py-2 hover:text-[color:var(--brand-primary)]">Contacto</a>
            <a
              href="#propiedades"
              class="mt-2 inline-flex w-full items-center justify-center rounded-lg bg-[color:var(--brand-primary)] px-4 py-2 text-white hover:opacity-90 transition-colors"
            >
              Ver propiedades
            </a>
          </div>
        </div>
      </div>
    </header>

    <main>
      <!-- Hero -->
      <section class="relative isolate">
        <div class="absolute inset-0 -z-10">
          <img
            src="https://pub-cdn.sider.ai/u/U0Z6H6GX0R3/web-coder/68bc90b5d4f5bb9dcd3b8249/resource/c0105bbf-bf3c-42e0-bc2b-88d39c05c4aa.jpg"
            alt="Lago en Bariloche"
            class="object-cover w-full h-full"
          />
          <div class="absolute inset-0 bg-[color:var(--brand-bg)] mix-blend-multiply opacity-30"></div>
          <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/45 to-black/30"></div>
        </div>

        <div class="mx-auto container-max px-4 py-16 md:py-24">
          <p class="text-[12px] sm:text-sm md:text-base text-white/90 font-light leading-snug">
            Natalia Gonz√°lez ‚Ä¢ Martillera y Corredora P√∫blica ‚Ä¢ MAT. N¬∫377- RP-21 F¬∫456 T¬∫II
          </p>

          <h1 class="mt-3 text-3xl md:text-5xl font-medium tracking-tight text-white">
            Tu pr√≥ximo hogar en Bariloche
          </h1>
          <p class="mt-2 text-base md:text-lg text-white/90 max-w-2xl">
            Acompa√±amiento de punta a punta.
          </p>

          <div class="mt-6 flex flex-wrap gap-3">
            <a
              href="#propiedades"
              class="rounded-lg bg-[color:var(--brand-primary)] text-white px-5 py-2.5 text-sm md:text-base hover:opacity-90 transition"
            >
              Ver propiedades
            </a>
          </div>
        </div>
      </section>

      <!-- Search Panel (funcional) -->
      <div class="mx-auto container-max px-4 -mt-14 relative z-10">
        <form id="search-form" class="rounded-xl border border-neutral-200 bg-white p-4 md:p-5 shadow-sm">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div class="flex flex-col">
              <label class="text-xs text-neutral-600 mb-1" for="filter-operation">Operaci√≥n</label>
              <select id="filter-operation" class="h-10 rounded-lg border border-neutral-300 px-3 bg-white">
                <option value="">Todas</option>
                <option>Venta</option>
                <option>Alquiler</option>
              </select>
            </div>
            <div class="flex flex-col">
              <label class="text-xs text-neutral-600 mb-1" for="filter-type">Tipo</label>
              <select id="filter-type" class="h-10 rounded-lg border border-neutral-300 px-3 bg-white">
                <option value="">Todos</option>
                <option>Casa</option>
                <option>Departamento</option>
                <option>Lote</option>
                <option>Local</option>
              </select>
            </div>
            <div class="flex flex-col md:col-span-2">
              <label class="text-xs text-neutral-600 mb-1" for="filter-location">Barrio/Zona</label>
              <input id="filter-location" class="h-10 rounded-lg border border-neutral-300 px-3 bg-white" placeholder="Ej. Centro" />
            </div>
            <div class="flex items-end gap-2">
              <button
                id="btn-search"
                type="submit"
                class="w-full md:w-auto h-10 rounded-lg bg-[color:var(--brand-primary)] text-white px-4 hover:opacity-90 transition"
              >
                Buscar
              </button>
              <button
                id="btn-reset"
                type="button"
                class="w-full md:w-auto h-10 rounded-lg border border-neutral-300 text-neutral-700 px-4 hover:bg-neutral-50 transition"
              >
                Limpiar
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Propiedades (din√°mico desde CSV) -->
      <section id="propiedades" class="mx-auto container-max px-4 pt-16">
        <div class="flex items-end justify-between flex-wrap gap-2">
          <div>
            <p class="text-xs uppercase tracking-[0.22em] text-[color:var(--brand-primary)]">Selecci√≥n</p>
            <h2 class="text-2xl md:text-3xl font-medium tracking-tight">Propiedades</h2>
          </div>
          <span id="prop-count" class="text-sm text-neutral-600"></span>
        </div>

        <div id="prop-grid" class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div id="prop-empty" class="mt-6 rounded-xl border border-neutral-200 bg-white p-4 text-sm text-neutral-700 hidden">
          <p>No hay resultados para los filtros aplicados.</p>
        </div>

        <div id="prop-config" class="mt-6 rounded-xl border border-amber-300 bg-amber-50 p-4 text-sm text-amber-900 hidden">
          <p>
            A√∫n no se configur√≥ la fuente de datos. Ingres√° a
            <a class="underline font-medium" href="/static/admin.html">Admin</a>
            para guardar la URL de tu Google Sheets (CSV). Luego volv√© a esta p√°gina.
          </p>
        </div>
      </section>

      <!-- Tasaci√≥n / Escribime -->
      <section id="tasacion" class="mx-auto container-max px-4 pt-20">
        <div>
          <p class="text-xs uppercase tracking-[0.22em] text-[color:var(--brand-primary)]">Tu propiedad</p>
          <h2 class="text-2xl md:text-3xl font-medium tracking-tight">Escribime</h2>
        </div>
        <p class="mt-2 text-neutral-700">
          Complet√° tus datos y el motivo de tu consulta; me contactar√© muy pronto.
        </p>

        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
          <form id="contact-form" class="rounded-xl border border-neutral-200 p-4 md:p-6 bg-white">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col">
                <label for="nombre" class="text-xs text-neutral-600 mb-1">Nombre</label>
                <input id="nombre" required class="h-10 rounded-lg border border-neutral-300 px-3 bg-white" placeholder="Tu nombre" />
              </div>

              <div class="flex flex-col">
                <label for="email" class="text-xs text-neutral-600 mb-1">Email</label>
                <input id="email" type="email" required class="h-10 rounded-lg border border-neutral-300 px-3 bg-white" placeholder="tucorreo@mail.com" />
              </div>

              <div class="flex flex-col">
                <label for="telefono" class="text-xs text-neutral-600 mb-1">Tel√©fono</label>
                <input id="telefono" required class="h-10 rounded-lg border border-neutral-300 px-3 bg-white" placeholder="+54 9 ..." />
              </div>

              <div class="flex flex-col">
                <label for="tipo" class="text-xs text-neutral-600 mb-1">Tipo de propiedad</label>
                <select id="tipo" required class="h-10 rounded-lg border border-neutral-300 px-3 bg-white">
                  <option value="" disabled selected>Seleccionar</option>
                  <option value="Casa">Casa</option>
                  <option value="Departamento">Departamento</option>
                  <option value="Lote">Lote</option>
                  <option value="Local">Local</option>
                </select>
              </div>

              <div class="flex flex-col">
                <label for="operacion" class="text-xs text-neutral-600 mb-1">Operaci√≥n</label>
                <select id="operacion" required class="h-10 rounded-lg border border-neutral-300 px-3 bg-white">
                  <option value="" disabled selected>Seleccionar</option>
                  <option value="Venta">Venta</option>
                  <option value="Alquiler">Alquiler</option>
                </select>
              </div>

              <div class="flex flex-col md:col-span-2">
                <label for="direccion" class="text-xs text-neutral-600 mb-1">Direcci√≥n</label>
                <input id="direccion" required class="h-10 rounded-lg border border-neutral-300 px-3 bg-white" placeholder="Calle, n√∫mero, barrio" />
              </div>

              <div class="flex flex-col md:col-span-2">
                <label for="mensaje" class="text-xs text-neutral-600 mb-1">Mensaje</label>
                <textarea id="mensaje" rows="4" class="rounded-lg border border-neutral-300 px-3 py-2 bg-white" placeholder="Detalles relevantes o el tema por el que quer√©s consultar"></textarea>
              </div>
            </div>

            <div class="mt-4 flex items-center justify-between gap-3">
              <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-[color:var(--brand-primary)] text-white h-10 px-4 hover:opacity-90 transition">
                Enviar
              </button>
              <span id="form-ok" class="text-sm text-green-700 hidden">¬°Gracias! Me contactar√© a la brevedad.</span>
            </div>
          </form>

          <div class="rounded-xl overflow-hidden border border-neutral-200 bg-neutral-50">
            <img
              src="https://pub-cdn.sider.ai/u/U0Z6H6GX0R3/web-coder/68bc90b5d4f5bb9dcd3b8249/resource/c4bf838c-8b53-4947-a908-295e7052c60c.jpg"
              alt="Bariloche"
              class="object-cover h-full w-full"
            />
          </div>
        </div>
      </section>

      <!-- Contacto -->
      <section id="contacto" class="mx-auto container-max px-4 pt-20 pb-24">
        <div class="w-full rounded-xl border border-neutral-200 bg-white p-6 break-words">
          <div>
            <p class="text-xs uppercase tracking-[0.22em] text-[color:var(--brand-primary)]">Contacto</p>
            <h2 class="text-2xl md:text-3xl font-medium tracking-tight">Hablemos</h2>
          </div>

          <div class="mt-4 space-y-2 text-sm md:text-base">
            <p class="text-neutral-700">
              Email
              <a
                href="mailto:nataliagonzalezmartillerapublica@ngespacios.com.ar"
                class="no-underline text-[color:var(--brand-primary)] hover:opacity-90 ml-1 break-all inline-block max-w-full align-baseline text-xs sm:text-sm md:text-base"
              >
                nataliagonzalezmartillerapublica@ngespacios.com.ar
              </a>
            </p>
            <p class="text-neutral-700">
              WhatsApp
              <a
                href="https://wa.me/5492944635083"
                target="_blank"
                rel="noreferrer"
                class="no-underline text-[color:var(--brand-primary)] hover:opacity-90 ml-1 break-all inline-block max-w-full align-baseline"
              >
                +54 9 294 463 5083
              </a>
            </p>
            <p class="text-neutral-700">San Carlos de Bariloche, R√≠o Negro, Argentina</p>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-neutral-200 mt-8">
      <div class="mx-auto container-max px-4 h-16 flex items-center justify-between text-sm">
        <p class="text-neutral-700">¬© <span id="year"></span> <span class="font-medium">NGespacios ‚Äî Natalia Gonz√°lez</span></p>
        <p class="text-neutral-700">Hecho con ‚ô• en Bariloche</p>
      </div>
    </footer>

    <!-- WhatsApp Floating -->
    <a
      href="https://wa.me/5492944635083"
      target="_blank"
      rel="noreferrer"
      class="fixed bottom-4 right-4 z-40 inline-flex items-center gap-2 rounded-full bg-green-600 text-white px-4 py-2 shadow-lg hover:bg-green-700 transition"
      aria-label="Contactar por WhatsApp"
    >
      <i data-lucide="message-circle" class="h-5 w-5"></i>
      WhatsApp
    </a>

    <!-- Modal Galer√≠a con Carrusel + Ficha -->
    <div
      id="gallery-modal"
      class="fixed inset-0 z-50 hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="gallery-title"
    >
      <div class="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>

      <div class="relative h-full w-full flex items-center justify-center px-4">
        <!-- Controles superiores -->
        <div class="absolute top-3 right-3 flex items-center gap-2 z-50">
          <a
            id="gallery-wa"
            href="#"
            target="_blank"
            rel="noreferrer"
            class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-green-600 text-white hover:bg-green-700 transition"
            title="WhatsApp"
            aria-label="Abrir WhatsApp"
          >
            <i data-lucide="message-circle" class="h-4 w-4"></i>
          </a>
          <button
            id="gallery-ficha-btn"
            type="button"
            class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-white/90 text-[color:var(--brand-primary)] border border-white hover:bg-white transition"
            title="Ficha"
            aria-label="Ver ficha"
          >
            <i data-lucide="file-text" class="h-4 w-4"></i>
          </button>
          <button
            id="gallery-close"
            type="button"
            class="inline-flex items-center justify-center h-9 w-9 rounded-full bg-white/90 text-black border border-white hover:bg-white transition"
            aria-label="Cerrar"
            title="Cerrar"
          >
            <i data-lucide="x" class="h-4 w-4"></i>
          </button>
        </div>

        <!-- Flechas -->
        <button
          id="gallery-prev"
          type="button"
          class="absolute left-3 md:left-6 top-1/2 -translate-y-1/2 inline-flex items-center justify-center h-9 w-9 rounded-full bg-white/90 text-black border border-white hover:bg-white transition z-40"
          aria-label="Anterior"
          title="Anterior"
        >
          <i data-lucide="chevron-left" class="h-4 w-4"></i>
        </button>
        <button
          id="gallery-next"
          type="button"
          class="absolute right-3 md:right-6 top-1/2 -translate-y-1/2 inline-flex items-center justify-center h-9 w-9 rounded-full bg-white/90 text-black border border-white hover:bg-white transition z-40"
          aria-label="Siguiente"
          title="Siguiente"
        >
          <i data-lucide="chevron-right" class="h-4 w-4"></i>
        </button>

        <!-- Imagen -->
        <figure class="relative w-full max-w-5xl aspect-[16/10] md:aspect-[16/9] lg:aspect-[21/9]">
          <img id="gallery-img" src="" alt="" class="object-contain w-full h-full select-none" />
          <!-- Indicadores -->
          <figcaption id="gallery-counter" class="absolute bottom-3 left-1/2 -translate-x-1/2 text-xs text-white/90 bg-black/40 px-2 py-1 rounded-md"></figcaption>
        </figure>

        <!-- Ficha compacta -->
        <div
          id="gallery-info"
          class="hidden absolute left-1/2 -translate-x-1/2 bottom-4 w-[95%] max-w-2xl rounded-lg border border-neutral-200 bg-white/95 backdrop-blur p-3 md:p-4 shadow-lg z-40"
        >
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 id="gallery-title" class="text-sm md:text-base font-medium tracking-tight"></h3>
              <p id="gallery-sub" class="text-xs text-neutral-600 mt-0.5"></p>
              <div class="mt-2 inline-flex items-center gap-2">
                <span id="gallery-badge-op" class="text-[10px] rounded-md bg-neutral-100 px-2 py-1"></span>
                <span id="gallery-badge-type" class="text-[10px] rounded-md bg-[color:var(--brand-primary)] text-white px-2 py-1"></span>
              </div>
            </div>
            <div class="text-[color:var(--brand-primary)] text-sm md:text-base font-semibold shrink-0" id="gallery-price"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS: UI (men√∫, formulario), CSV loader, render de propiedades y buscador -->
    <script>
      /**
       * @file index.html script
       * @description Interactividad del home: men√∫, formulario de contacto, carga de CSV,
       *              render din√°mico de propiedades, buscador, y galer√≠a.
       */

      // A√±o
      document.getElementById('year').textContent = new Date().getFullYear();

      // Lucide render
      const renderIcons = () => { if (window.lucide) window.lucide.createIcons(); };
      window.addEventListener('DOMContentLoaded', renderIcons);

      // Scroll suave para anclas internas
      document.querySelectorAll('a[href^="#"]').forEach((a) => {
        a.addEventListener('click', (e) => {
          const href = a.getAttribute('href');
          if (!href || href === '#') return;
          e.preventDefault();
          const el = document.querySelector(href);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });

      // Men√∫ m√≥vil
      const btnMobile = document.getElementById('btn-mobile');
      const mobileMenu = document.getElementById('mobile-menu');
      const toggleMenu = (open) => {
        const willOpen = typeof open === 'boolean' ? open : mobileMenu.classList.contains('hidden');
        mobileMenu.classList.toggle('hidden', !willOpen);
        btnMobile?.setAttribute('aria-expanded', String(willOpen));
        if (window.lucide) {
          btnMobile.innerHTML = willOpen ? '<i data-lucide="x" class="h-4 w-4"></i>' : '<i data-lucide="menu" class="h-4 w-4"></i>';
          window.lucide.createIcons();
        }
      };
      btnMobile?.addEventListener('click', () => toggleMenu());
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggleMenu(false); });
      mobileMenu?.querySelectorAll('a').forEach((link) => { link.addEventListener('click', () => toggleMenu(false)); });
      window.addEventListener('resize', () => { if (window.innerWidth >= 768) toggleMenu(false); });

      // Simulaci√≥n de env√≠o del formulario (muestra mensaje de ok)
      const form = document.getElementById('contact-form');
      const ok = document.getElementById('form-ok');
      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        ok?.classList.remove('hidden');
        setTimeout(() => { form.reset(); }, 200);
      });

      // --------------------------
      // Utilidades CSV + Render
      // --------------------------
      const LS_KEY_CSV = 'ngespacios:csvUrl';

      /** Normaliza URLs de Google Sheets a CSV */
      function normalizeSheetUrlToCsv(url) {
        try {
          const u = new URL(url);
          if (u.hostname.includes('docs.google.com')) {
            if (u.pathname.endsWith('/pub')) {
              u.searchParams.set('output', 'csv');
              return u.toString();
            }
            if (u.pathname.includes('/export')) {
              u.searchParams.set('format', 'csv');
              return u.toString();
            }
          }
          return url;
        } catch {
          return url;
        }
      }

      /**
       * Parser CSV simple con soporte de comillas dobles
       * @param {string} text
       * @returns {Array<Object>}
       */
      function parseCSV(text) {
        const rows = [];
        let i = 0, field = '', row = [], inQuotes = false;

        function pushField() {
          row.push(field.replace(/\\"\\"/g, '\\"'));
          field = '';
        }
        function pushRow() {
          rows.push(row);
          row = [];
        }

        while (i < text.length) {
          const c = text[i];
          if (inQuotes) {
            if (c === '\\"') {
              if (text[i + 1] === '\\"') {
                field += '\\"';
                i += 2; continue;
              } else {
                inQuotes = false; i++; continue;
              }
            } else {
              field += c; i++; continue;
            }
          } else {
            if (c === '\\"') { inQuotes = true; i++; continue; }
            if (c === ',') { pushField(); i++; continue; }
            if (c === '\\n') { pushField(); pushRow(); i++; continue; }
            if (c === '\\r') { i++; continue; }
            field += c; i++;
          }
        }
        pushField();
        if (row.length > 1 || (row.length === 1 && row[0] !== '')) pushRow();

        if (rows.length === 0) return [];
        const headers = rows[0].map((h) => (h || '').trim());
        const data = [];
        for (let r = 1; r < rows.length; r++) {
          const values = rows[r];
          const obj = {};
          headers.forEach((h, idx) => { obj[h] = (values[idx] || '').trim(); });
          data.push(obj);
        }
        return data;
      }

      /** Descarga texto CSV evitando cach√© */
      async function fetchCsv(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.text();
      }

      /** Devuelve la primera imagen v√°lida desde "images" (separadas por |) */
      function firstImage(p) {
        const raw = p.images || '';
        const parts = raw.split('|').map((s) => s.trim()).filter(Boolean);
        return parts[0] || '';
      }

      /** Construye un texto de precio a partir de price_label o (amount+currency+period) */
      function formatPrice(p) {
        const label = p.price_label || '';
        if (label) return label;
        const amount = p.price_amount || '';
        const curr = p.price_currency || '';
        const period = p.price_period || '';
        let text = '';
        if (curr && amount) text = `${curr} ${amount}`;
        else if (amount) text = amount;
        if (period) text += ` ${period}`;
        return text;
      }

      // --------------------------
      // Render de tarjetas + Galer√≠a
      // --------------------------
      const WA_PHONE = '5492944635083';

      /** Arma el link a WhatsApp con mensaje precargado */
      function buildWaLink({ title, operation, type, location, price }) {
        const msg = `Hola Natalia, me interesa la propiedad "${title}" (${operation} - ${type}) en ${location}. Precio: ${price}. ¬øPodemos coordinar una visita? Gracias.`;
        return `https://wa.me/${WA_PHONE}?text=${encodeURIComponent(msg)}`;
      }

      /** Crea el nodo Article de una propiedad */
      function createPropertyCard(p) {
        const card = document.createElement('article');
        card.className = 'group rounded-xl border border-neutral-200 overflow-hidden bg-white shadow-sm hover:shadow-md transition';
        card.setAttribute('data-title', p.title || '');
        card.setAttribute('data-operation', p.operation || '');
        card.setAttribute('data-type', p.type || '');
        card.setAttribute('data-location', p.location || '');
        card.setAttribute('data-price', formatPrice(p));
        card.setAttribute('data-images', (p.images || '').split('|').map(s => s.trim()).filter(Boolean).join('|'));

        // Imagen
        const imgWrap = document.createElement('div');
        imgWrap.className = 'relative h-48 w-full overflow-hidden';

        const btnOpen = document.createElement('button');
        btnOpen.type = 'button';
        btnOpen.className = 'absolute inset-0 z-10';
        btnOpen.setAttribute('data-action', 'open-gallery');
        btnOpen.setAttribute('title', 'Abrir galer√≠a');
        btnOpen.setAttribute('aria-label', 'Abrir galer√≠a');

        const img = document.createElement('img');
        img.src = firstImage(p) || 'https://pub-cdn.sider.ai/u/U0Z6H6GX0R3/web-coder/68bc90b5d4f5bb9dcd3b8249/resource/436c51ea-42dc-495c-a5ed-840f07947a61.jpg';
        img.alt = p.title || 'Foto de propiedad';
        img.className = 'object-cover h-full w-full';

        const badges = document.createElement('div');
        badges.className = 'absolute top-3 left-3 flex gap-2';
        const op = document.createElement('span');
        op.className = 'rounded-md bg-white/90 px-2 py-1 text-xs font-medium';
        op.textContent = p.operation || '';
        const typ = document.createElement('span');
        typ.className = 'rounded-md bg-[color:var(--brand-primary)] text-white px-2 py-1 text-xs font-medium';
        typ.textContent = p.type || '';
        if (p.operation) badges.appendChild(op);
        if (p.type) badges.appendChild(typ);

        imgWrap.appendChild(btnOpen);
        imgWrap.appendChild(img);
        imgWrap.appendChild(badges);
        card.appendChild(imgWrap);

        // Contenido
        const content = document.createElement('div');
        content.className = 'p-4';

        const h3 = document.createElement('h3');
        h3.className = 'font-medium tracking-tight line-clamp-1';
        h3.textContent = p.title || 'Sin t√≠tulo';

        const loc = document.createElement('div');
        loc.className = 'mt-1 flex items-center gap-1 text-sm text-neutral-600';
        loc.innerHTML = '<i data-lucide="map-pin" class="h-4 w-4"></i><span class="line-clamp-1"></span>';
        loc.querySelector('span').textContent = p.location || '';

        const specs = document.createElement('ul');
        specs.className = 'mt-3 flex flex-wrap gap-x-3 gap-y-2 text-xs text-neutral-700';
        const specItems = [
          p.bedrooms ? { icon: 'bed', text: `${p.bedrooms} hab` } : null,
          p.bathrooms ? { icon: 'bath', text: `${p.bathrooms} ba√±os` } : null,
          p.garages ? { icon: 'car', text: `${p.garages} coch` } : null,
          p.area_m2 ? { icon: 'square', text: `${p.area_m2} m¬≤ cub.` } : null,
          p.lot_m2 ? { icon: 'ruler', text: `${p.lot_m2} m¬≤ lote` } : null
        ].filter(Boolean);
        specItems.forEach((s) => {
          const li = document.createElement('li');
          li.className = 'inline-flex items-center gap-1';
          li.innerHTML = `<i data-lucide="${s.icon}" class="h-4 w-4 text-neutral-600"></i><span>${s.text}</span>`;
          specs.appendChild(li);
        });

        const footer = document.createElement('div');
        footer.className = 'mt-3 flex items-center justify-between';

        const price = document.createElement('span');
        price.className = 'text-lg font-semibold text-[color:var(--brand-primary)]';
        price.textContent = formatPrice(p);

        const ctas = document.createElement('div');
        ctas.className = 'flex gap-2';

        const aWa = document.createElement('a');
        aWa.target = '_blank';
        aWa.rel = 'noreferrer';
        aWa.className = 'text-sm rounded-md bg-[color:var(--brand-primary)] text-white px-3 py-1.5 hover:opacity-90 transition';
        aWa.textContent = 'WhatsApp';
        aWa.href = buildWaLink({
          title: p.title || '',
          operation: p.operation || '',
          type: p.type || '',
          location: p.location || '',
          price: formatPrice(p)
        });

        const btnFicha = document.createElement('button');
        btnFicha.type = 'button';
        btnFicha.className = 'text-sm rounded-md border border-[color:var(--brand-primary)] text-[color:var(--brand-primary)] px-3 py-1.5 hover:bg-[color:var(--brand-primary)] hover:text-white transition';
        btnFicha.textContent = 'Ficha';
        btnFicha.setAttribute('data-action', 'open-gallery-ficha');

        ctas.appendChild(aWa);
        ctas.appendChild(btnFicha);

        footer.appendChild(price);
        footer.appendChild(ctas);

        content.appendChild(h3);
        content.appendChild(loc);
        if (specItems.length) content.appendChild(specs);
        content.appendChild(footer);

        card.appendChild(content);

        return card;
      }

      /** Estado simple de galer√≠a */
      const galleryState = {
        images: [],
        index: 0,
        meta: { title: '', operation: '', type: '', location: '', price: '' },
        infoOpen: false,
      };

      // Elementos de galer√≠a
      const modal = document.getElementById('gallery-modal');
      const imgEl = document.getElementById('gallery-img');
      const counterEl = document.getElementById('gallery-counter');
      const closeBtn = document.getElementById('gallery-close');
      const prevBtn = document.getElementById('gallery-prev');
      const nextBtn = document.getElementById('gallery-next');
      const fichaBtn = document.getElementById('gallery-ficha-btn');
      const infoPanel = document.getElementById('gallery-info');
      const waBtn = document.getElementById('gallery-wa');

      const titleEl = document.getElementById('gallery-title');
      const subEl = document.getElementById('gallery-sub');
      const priceEl = document.getElementById('gallery-price');
      const badgeOp = document.getElementById('gallery-badge-op');
      const badgeType = document.getElementById('gallery-badge-type');

      /** Actualiza la UI con la imagen actual */
      function updateGalleryUI() {
        if (!galleryState.images.length) return;
        imgEl.src = galleryState.images[galleryState.index];
        imgEl.alt = galleryState.meta.title || 'Imagen de propiedad';
        counterEl.textContent = (galleryState.index + 1) + ' / ' + galleryState.images.length;

        // Datos de ficha
        titleEl.textContent = galleryState.meta.title;
        subEl.textContent = galleryState.meta.location;
        priceEl.textContent = galleryState.meta.price;
        badgeOp.textContent = galleryState.meta.operation;
        badgeType.textContent = galleryState.meta.type;

        // Link de WhatsApp
        waBtn.href = buildWaLink(galleryState.meta);

        // Render de iconos luego de actualizar botones
        renderIcons();
      }

      /** Abre el modal de galer√≠a */
      function openGallery({ images, meta, startIndex = 0, openFicha = false }) {
        galleryState.images = images;
        galleryState.index = Math.max(0, Math.min(startIndex, images.length - 1));
        galleryState.meta = meta;
        galleryState.infoOpen = !!openFicha;

        // Mostrar/ocultar ficha compacta
        infoPanel.classList.toggle('hidden', !galleryState.infoOpen);

        // Mostrar modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        updateGalleryUI();
      }

      /** Cierra el modal */
      function closeGallery() {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
      }

      /** Navegaci√≥n */
      function prevImage() {
        if (!galleryState.images.length) return;
        galleryState.index = (galleryState.index - 1 + galleryState.images.length) % galleryState.images.length;
        updateGalleryUI();
      }
      function nextImage() {
        if (!galleryState.images.length) return;
        galleryState.index = (galleryState.index + 1) % galleryState.images.length;
        updateGalleryUI();
      }

      /** Toggle ficha */
      function toggleFicha() {
        galleryState.infoOpen = !galleryState.infoOpen;
        infoPanel.classList.toggle('hidden', !galleryState.infoOpen);
      }

      // Eventos globales del modal
      closeBtn.addEventListener('click', closeGallery);
      prevBtn.addEventListener('click', prevImage);
      nextBtn.addEventListener('click', nextImage);
      fichaBtn.addEventListener('click', toggleFicha);

      // Cerrar al clickear fuera (overlay)
      modal.addEventListener('click', (e) => {
        const isBackdrop = e.target === modal || e.target === modal.firstElementChild;
        if (isBackdrop) closeGallery();
      });

      // Teclado
      document.addEventListener('keydown', (e) => {
        if (modal.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeGallery();
        if (e.key === 'ArrowLeft') prevImage();
        if (e.key === 'ArrowRight') nextImage();
      });

      // --------------------------
      // Estado y filtros
      // --------------------------
      let ALL_PROPS = [];
      const grid = document.getElementById('prop-grid');
      const empty = document.getElementById('prop-empty');
      const cfg = document.getElementById('prop-config');
      const count = document.getElementById('prop-count');

      const selOp = document.getElementById('filter-operation');
      const selType = document.getElementById('filter-type');
      const inLoc = document.getElementById('filter-location');
      const searchForm = document.getElementById('search-form');
      const btnReset = document.getElementById('btn-reset');

      /** Conecta botones de cada tarjeta a la galer√≠a */
      function wireCardGallery(card) {
        function parseImages(str) {
          return (str || '')
            .split('|')
            .map((s) => s.trim())
            .filter(Boolean);
        }
        const meta = {
          title: card.getAttribute('data-title') || '',
          operation: card.getAttribute('data-operation') || '',
          type: card.getAttribute('data-type') || '',
          location: card.getAttribute('data-location') || '',
          price: card.getAttribute('data-price') || '',
        };
        const imgs = parseImages(card.getAttribute('data-images') || '');

        const openButtons = card.querySelectorAll('[data-action="open-gallery"]');
        openButtons.forEach((btn) => btn.addEventListener('click', () => openGallery({ images: imgs, meta, startIndex: 0, openFicha: false })));

        const openFichaBtn = card.querySelector('[data-action="open-gallery-ficha"]');
        openFichaBtn?.addEventListener('click', () => openGallery({ images: imgs, meta, startIndex: 0, openFicha: true }));
      }

      /** Renderiza una lista de propiedades */
      function renderList(list) {
        grid.innerHTML = '';
        if (!list || list.length === 0) {
          empty.classList.remove('hidden');
          count.textContent = '';
          renderIcons();
          return;
        }
        empty.classList.add('hidden');
        list.forEach((p) => {
          const card = createPropertyCard(p);
          grid.appendChild(card);
          wireCardGallery(card);
        });
        count.textContent = list.length + ' resultados';
        renderIcons();
      }

      /** Aplica filtros del buscador */
      function applyFilters() {
        const op = (selOp.value || '').trim().toLowerCase();
        const type = (selType.value || '').trim().toLowerCase();
        const loc = (inLoc.value || '').trim().toLowerCase();

        const filtered = ALL_PROPS.filter((p) => {
          const pOp = (p.operation || '').toLowerCase();
          const pType = (p.type || '').toLowerCase();
          const pLoc = (p.location || '').toLowerCase();

          const okOp = !op || pOp === op;
          const okType = !type || pType === type;
          const okLoc = !loc || pLoc.includes(loc);

          return okOp && okType && okLoc;
        });

        renderList(filtered);
      }

      /** Carga inicial desde CSV (localStorage o default) */
      async function bootstrap() {
        try {
          const saved = localStorage.getItem(LS_KEY_CSV) || '';
          const csvUrl = saved || 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRE45mae2W4RPiAVFq7Jl8E0WeD7XXoPxXDT6oGKXFPxAACcGVC30Bq-FUcbM90iIn5H-5ddOr9hl1K/pub?output=csv';

          if (!csvUrl) {
            cfg.classList.remove('hidden');
            renderList([]);
            return;
          }

          const normalized = normalizeSheetUrlToCsv(csvUrl);
          const text = await fetchCsv(normalized);
          const rows = parseCSV(text);
          // Filtrar filas m√≠nimas v√°lidas
          ALL_PROPS = rows.filter((r) => (r.id || '').trim() && (r.title || '').trim());

          cfg.classList.add('hidden');
          renderList(ALL_PROPS);
        } catch (e) {
          console.error(e);
          cfg.classList.remove('hidden');
          renderList([]);
        }
      }

      // Eventos buscador
      searchForm?.addEventListener('submit', (e) => { e.preventDefault(); applyFilters(); });
      btnReset?.addEventListener('click', () => {
        selOp.value = '';
        selType.value = '';
        inLoc.value = '';
        renderList(ALL_PROPS);
      });

      // Init
      bootstrap();
    </script>

    <!-- Script anti-badge adicional: elimina overlays/badges inyectados por hosts (p. ej. Vercel) -->
    <script>
      (function hideHostBadges(){
        const selectors = [
          'a[href*="vercel.com"]',
          'a[href*="vercel.app"]',
          '[aria-label*="Vercel" i]',
          '[aria-label*="vercel" i]',
          '[data-vercel-insights]',
          '[data-vercel-analytics]',
          '[data-ai-insights]',
          '[data-nextjs-toast]',
          '[data-vc]',
          '[data-vercel-banner]',
          'img[alt*="vercel" i]',
          'iframe[src*="vercel" i]',
          '.vercel-badge',
          '#vercel',
          '#__vercel'
        ];
        const removeAll = () => {
          try { document.querySelectorAll(selectors.join(',')).forEach((el) => el.remove()); } catch {}
        };
        const obs = new MutationObserver(removeAll);
        obs.observe(document.documentElement, { subtree: true, childList: true });
        removeAll();
        setTimeout(() => obs.disconnect(), 8000);
      })();
    </script>

    <!-- Admin force-open helper: ensures the panel shows when ?admin=1 (supports ngd- and ng- variants) -->
    <script>
      /**
       * @file force-admin-open
       * @description If the URL contains ?admin=1, make any admin panel visible (ngd- or ng- variants).
       */
      (function forceOpenAdmin(){
        try {
          const u = new URL(location.href);
          if (u.searchParams.get('admin') !== '1') return;
        } catch { return; }

        const SHOW = (el) => {
          if (!el) return false;
          el.classList?.remove('hidden', 'ng-hidden');
          if (el.style) { el.style.display = 'block'; el.style.visibility = 'visible'; }
          el.setAttribute?.('aria-hidden','false');
          el.scrollIntoView?.({ behavior: 'smooth', block: 'start' });
          return true;
        };

        const tryShow = () => {
          const a = document.getElementById('ngd-admin-panel') || document.getElementById('ng-admin-panel');
          if (a) {
            SHOW(a);
            const t = document.getElementById('ngd-admin-toggle') || document.getElementById('ng-admin-toggle');
            if (t) t.setAttribute('aria-pressed','true');
            const i = document.getElementById('ngd-csv') || document.getElementById('ng-csv-url') || a.querySelector('input[type="url"]');
            i?.focus();
            return true;
          }
          return false;
        };

        if (tryShow()) return;
        const maxMs = 2000; const start = Date.now();
        const iv = setInterval(() => {
          if (tryShow() || Date.now() - start > maxMs) clearInterval(iv);
        }, 120);
      })();
    </script>
    <!--
  
<!-- Ra√≠z del drop-in -->
<div
  id="ngespacios-admin-dropin"
  data-csv-default="https://docs.google.com/spreadsheets/d/e/2PACX-1vRE45mae2W4RPiAVFq7Jl8E0WeD7XXoPxXDT6oGKXFPxAACcGVC30Bq-FUcbM90iIn5H-5ddOr9hl1K/pub?output=csv"
  data-cta-text="ver propiedades"
>
  <!-- Estilos m√≠nimos, con buen contraste y sin dependencias -->
  <style>
    /* Reset peque√±o para este bloque */
    #ngespacios-admin-dropin * { box-sizing: border-box; }
    #ngespacios-admin-dropin .ng-hidden { display: none !important; }

    /* Tarjetas y panel */
    #ngespacios-admin-dropin .ng-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(16,24,40,0.04);
      padding: 16px;
    }
    #ngespacios-admin-dropin .ng-muted { color: #6b7280; }
    #ngespacios-admin-dropin .ng-strong { color: #111827; }
    #ngespacios-admin-dropin .ng-accent { color: #0c4a6e; } /* azul profundo */
    #ngespacios-admin-dropin .ng-badge {
      display: inline-block;
      border: 1px solid #e5e7eb;
      color: #374151;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      line-height: 18px;
      background: #f9fafb;
    }

    /* Botones */
    #ngespacios-admin-dropin .ng-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #374151;
      cursor: pointer;
    }
    #ngespacios-admin-dropin .ng-btn:hover { background: #f9fafb; }
    #ngespacios-admin-dropin .ng-btn-primary {
      border-color: #0ea5e9;
      background: #0284c7;
      color: #fff;
    }
    #ngespacios-admin-dropin .ng-btn-primary:hover { background: #0369a1; }
    #ngespacios-admin-dropin .ng-btn-ghost {
      background: #fff;
      color: #0c4a6e;
      border-color: #cbd5e1;
    }
    #ngespacios-admin-dropin .ng-btn-ghost[aria-pressed="true"] {
      background: #e0f2fe;
      color: #075985;
      border-color: #0ea5e9;
    }

    /* Inputs */
    #ngespacios-admin-dropin .ng-input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    #ngespacios-admin-dropin .ng-input:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14,165,233,0.2);
    }

    /* Grilla de propiedades */
    #ngespacios-admin-dropin .ng-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 16px;
    }
    @media (min-width: 640px) {
      #ngespacios-admin-dropin .ng-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 1024px) {
      #ngespacios-admin-dropin .ng-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* Tarjeta */
    #ngespacios-admin-dropin .ng-card-image {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 10px;
      overflow: hidden;
      background: linear-gradient(135deg, #e5e7eb, #f3f4f6);
      border: 1px solid #e5e7eb;
    }
    #ngespacios-admin-dropin .ng-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    #ngespacios-admin-dropin .ng-card-title {
      font-weight: 700;
      font-size: 16px;
      color: #111827;
      margin: 8px 0 2px 0;
    }
    #ngespacios-admin-dropin .ng-card-sub {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    #ngespacios-admin-dropin .ng-price {
      font-weight: 600;
      color: #0c4a6e;
      margin-bottom: 8px;
    }

    /* Secci√≥n */
    #ngespacios-admin-dropin .ng-section {
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
    }
    #ngespacios-admin-dropin .ng-section h2 {
      font-size: 24px;
      font-weight: 800;
      margin: 4px 0 2px;
      color: #111827;
    }
    #ngespacios-admin-dropin .ng-flex-between {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    /* Admin flotante como fallback */
    #ngespacios-admin-dropin .ng-fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 50;
    }

    /* Avisos */
    #ngespacios-admin-dropin .ng-alert {
      margin-top: 8px;
      font-size: 13px;
    }
    #ngespacios-admin-dropin .ng-error { color: #b91c1c; }
    #ngespacios-admin-dropin .ng-hint { color: #6b7280; }
  </style>

  <!-- Panel Admin (oculto por defecto) -->
  <section id="ng-admin-panel" class="ng-card ng-section ng-hidden" role="region" aria-label="Panel de administraci√≥n">
    <div style="display:flex; flex-wrap:wrap; align-items:center; gap:12px;">
      <div class="ng-strong" style="display:flex; align-items:center; gap:8px; font-size:14px;">
        <span aria-hidden="true">üîó</span> Fuente de datos (CSV p√∫blico)
      </div>
      <input
        id="ng-csv-url"
        type="url"
        placeholder="https://docs.google.com/spreadsheets/.../export?format=csv"
        class="ng-input"
        style="flex:1 1 320px;"
        aria-label="URL de Google Sheets en formato CSV"
      />
      <button id="ng-btn-test" class="ng-btn" title="Probar carga">‚ü≥ Probar</button>
      <button id="ng-btn-save" class="ng-btn ng-btn-primary" title="Guardar en este navegador">‚úî Guardar</button>
    </div>
    <p id="ng-admin-msg" class="ng-alert ng-hint">Public√° tu hoja como CSV en Google Sheets o compartila como ‚ÄúCualquiera con el enlace: lector‚Äù.</p>
  </section>

  <!-- Secci√≥n Propiedades (listado) -->
  <section id="propiedades" class="ng-section" aria-label="Propiedades">
    <div class="ng-flex-between">
      <div>
        <h2>Propiedades</h2>
        <p class="ng-muted" style="font-size:13px;">Listado le√≠do desde tu hoja publicada.</p>
      </div>
      <span id="ng-results" class="ng-muted" style="font-size:13px;"></span>
    </div>
    <div id="ng-grid" class="ng-grid"></div>
    <div id="ng-empty" class="ng-card ng-hidden" style="text-align:center;">
      <p class="ng-strong" style="margin-bottom:4px;">No hay propiedades para mostrar</p>
      <p class="ng-muted" style="font-size:13px;">Verific√° el enlace de CSV o agreg√° filas en tu hoja. Luego toc√° ‚ÄúProbar‚Äù.</p>
    </div>
  </section>
</div>

<script>
  ;(() => {
    /**
     * @constant LS_KEY
     * @description Clave para guardar/leer la URL CSV en el navegador.
     */
    const LS_KEY = 'ngespacios:csvUrl'

    // Elementos base
    const root = document.getElementById('ngespacios-admin-dropin')
    if (!root) return
    const CTA_TEXT = (root.dataset.ctaText || 'ver propiedades').toLowerCase().trim()
    const defaultCsv = root.dataset.csvDefault || ''

    const elPanel = document.getElementById('ng-admin-panel')
    const elInput = document.getElementById('ng-csv-url')
    const elMsg = document.getElementById('ng-admin-msg')
    const elGrid = document.getElementById('ng-grid')
    const elEmpty = document.getElementById('ng-empty')
    const elResults = document.getElementById('ng-results')

    /**
     * @function normalizeSheetUrlToCsv
     * @description Normaliza URLs de Google Sheets a CSV.
     *  - .../pub?output=ods|pdf|html -> output=csv
     *  - .../export?format=... -> format=csv
     */
    function normalizeSheetUrlToCsv(url) {
      try {
        const u = new URL(url)
        if (u.hostname.includes('docs.google.com')) {
          if (u.pathname.endsWith('/pub')) {
            u.searchParams.set('output', 'csv')
            return u.toString()
          }
          if (u.pathname.includes('/export')) {
            u.searchParams.set('format', 'csv')
            return u.toString()
          }
        }
        return url
      } catch {
        return url
      }
    }

    /**
     * @function parseCSV
     * @description Parser CSV simple con soporte de valores entre comillas dobles.
     * @param {string} text - Contenido CSV.
     * @returns {Array<Object>} Registros como objetos plano {columna: valor}.
     */
    function parseCSV(text) {
      const rows = []
      let i = 0, field = '', row = [], inQuotes = false

      function pushField() {
        // Reemplaza doble comilla escapada ("") por una sola
        row.push(field.replace(/""/g, '"'))
        field = ''
      }
      function pushRow() {
        rows.push(row)
        row = []
      }

      while (i < text.length) {
        const c = text[i]
        if (inQuotes) {
          if (c === '"') {
            if (text[i + 1] === '"') {
              field += '"'
              i += 2
              continue
            } else {
              inQuotes = false
              i++
              continue
            }
          } else {
            field += c
            i++
            continue
          }
        } else {
          if (c === '"') {
            inQuotes = true
            i++
            continue
          }
          if (c === ',') {
            pushField()
            i++
            continue
          }
          if (c === '\n') {
            pushField()
            pushRow()
            i++
            continue
          }
          if (c === '\r') { i++; continue } // Ignora CR
          field += c
          i++
        }
      }
      // √öltimo campo/fila
      pushField()
      if (row.length > 1 || (row.length === 1 && row[0] !== '')) pushRow()

      if (rows.length === 0) return []

      const headers = rows[0].map((h) => (h || '').trim())
      const data = []
      for (let r = 1; r < rows.length; r++) {
        const values = rows[r]
        const obj = {}
        headers.forEach((h, idx) => { obj[h] = (values[idx] || '').trim() })
        data.push(obj)
      }
      return data
    }

    /**
     * @function fetchCsv
     * @description Descarga texto CSV con no-store para evitar cach√©.
     */
    async function fetchCsv(url) {
      const res = await fetch(url, { cache: 'no-store' })
      if (!res.ok) throw new Error('HTTP ' + res.status)
      return res.text()
    }

    /**
     * @function firstImage
     * @description Devuelve la primera imagen v√°lida desde el campo "images" (separadas por "|").
     */
    function firstImage(p) {
      const raw = p.images || ''
      const parts = raw.split('|').map((s) => s.trim()).filter(Boolean)
      return parts[0] || ''
    }

    /**
     * @function formatPrice
     * @description Construye un texto de precio a partir de price_label o (amount+currency+period).
     */
    function formatPrice(p) {
      const label = p.price_label || ''
      if (label) return label
      const amount = p.price_amount || ''
      const curr = p.price_currency || ''
      const period = p.price_period || ''
      let text = ''
      if (curr && amount) text = `${curr} ${amount}`
      else if (amount) text = amount
      if (period) text += ` ${period}`
      return text
    }

    /**
     * @function createCard
     * @description Construye la tarjeta DOM para una propiedad.
     */
    function createCard(p) {
      const card = document.createElement('article')
      card.className = 'ng-card'
      card.setAttribute('aria-label', p.title || 'Propiedad')

      // Imagen
      const imgWrap = document.createElement('div')
      imgWrap.className = 'ng-card-image'
      const imgUrl = firstImage(p)
      if (imgUrl) {
        const img = document.createElement('img')
        img.src = imgUrl
        img.alt = p.title || 'Foto de propiedad'
        imgWrap.appendChild(img)
      }
      card.appendChild(imgWrap)

      // T√≠tulo
      const title = document.createElement('div')
      title.className = 'ng-card-title'
      title.textContent = p.title || 'Sin t√≠tulo'
      card.appendChild(title)

      // Subt√≠tulo
      const sub = document.createElement('div')
      sub.className = 'ng-card-sub'
      const op = p.operation ? p.operation : ''
      const type = p.type ? p.type : ''
      const loc = p.location ? ` ‚Ä¢ ${p.location}` : ''
      sub.textContent = [op, type].filter(Boolean).join(' ') + loc
      card.appendChild(sub)

      // Precio
      const priceText = formatPrice(p)
      if (priceText) {
        const price = document.createElement('div')
        price.className = 'ng-price'
        price.textContent = priceText
        card.appendChild(price)
      }

      // Badges
      const badges = document.createElement('div')
      badges.style.display = 'flex'
      badges.style.flexWrap = 'wrap'
      badges.style.gap = '8px'

      ;[
        p.bedrooms ? `${p.bedrooms} hab.` : '',
        p.bathrooms ? `${p.bathrooms} ba√±os` : '',
        p.garages ? `${p.garages} coch.` : '',
        p.area_m2 ? `${p.area_m2} m¬≤` : '',
        p.lot_m2 ? `${p.lot_m2} m¬≤ lote` : '',
        p.status ? `${p.status}` : ''
      ].filter(Boolean).forEach((t) => {
        const b = document.createElement('span')
        b.className = 'ng-badge'
        b.textContent = t
        badges.appendChild(b)
      })

      if (badges.childNodes.length) card.appendChild(badges)

      return card
    }

    /**
     * @function renderList
     * @description Pinta la lista de propiedades y el estado de resultados.
     */
    function renderList(list) {
      elGrid.innerHTML = ''
      if (!list || list.length === 0) {
        elResults.textContent = ''
        elEmpty.classList.remove('ng-hidden')
        return
      }
      elEmpty.classList.add('ng-hidden')
      for (const p of list) {
        elGrid.appendChild(createCard(p))
      }
      elResults.textContent = list.length + ' resultados'
    }

    /**
     * @function findVerPropiedadesLink
     * @description Busca el primer enlace cuyo texto incluya "ver propiedades" (ignora may√∫sculas/min√∫sculas).
     */
    function findVerPropiedadesLink() {
      const links = Array.from(document.querySelectorAll('a'))
      for (const a of links) {
        const txt = (a.textContent || '').toLowerCase().trim()
        if (txt.includes(CTA_TEXT)) return a
      }
      return null
    }

    /**
     * @function ensureAdminButton
     * @description Inserta el bot√≥n "Admin" junto al CTA. Si no encuentra el CTA, lo muestra flotante abajo a la derecha.
     */
    function ensureAdminButton() {
      const btn = document.createElement('button')
      btn.id = 'ng-admin-toggle'
      btn.className = 'ng-btn ng-btn-ghost'
      btn.type = 'button'
      btn.setAttribute('aria-pressed', 'false')
      btn.textContent = 'Admin'
      btn.addEventListener('click', () => {
        const isOpen = !elPanel.classList.contains('ng-hidden')
        if (isOpen) {
          elPanel.classList.add('ng-hidden')
          btn.setAttribute('aria-pressed', 'false')
        } else {
          elPanel.classList.remove('ng-hidden')
          btn.setAttribute('aria-pressed', 'true')
          elInput?.focus()
        }
      })

      const cta = findVerPropiedadesLink()
      if (cta && cta.parentElement) {
        cta.insertAdjacentElement('afterend', btn)
      } else {
        // Fallback flotante
        const wrap = document.createElement('div')
        wrap.className = 'ng-fab'
        wrap.appendChild(btn)
        document.body.appendChild(wrap)
      }

      // Soporte ?admin=1
      try {
        const u = new URL(window.location.href)
        if (u.searchParams.get('admin') === '1') {
          elPanel.classList.remove('ng-hidden')
          btn.setAttribute('aria-pressed', 'true')
          elInput?.focus()
        }
      } catch {}
    }

    /**
     * @function loadFrom
     * @description Descarga CSV, parsea y renderiza.
     */
    async function loadFrom(url) {
      try {
        elMsg.classList.remove('ng-error')
        elMsg.classList.add('ng-hint')
        elMsg.textContent = 'Cargando datos...'
        const normalized = normalizeSheetUrlToCsv(url)
        const text = await fetchCsv(normalized)
        const rows = parseCSV(text)
        // Filtra filas sin id o sin t√≠tulo
        const data = rows.filter((r) => (r.id || '').trim() && (r.title || '').trim())
        renderList(data)
        elMsg.textContent = 'Datos cargados.'
      } catch (e) {
        console.error(e)
        renderList([])
        elMsg.classList.remove('ng-hint')
        elMsg.classList.add('ng-error')
        elMsg.textContent = 'No se pudo cargar el CSV. Revis√° el enlace o permisos.'
      }
    }

    /**
     * @function init
     * @description Inicializa: bot√≥n admin, eventos y carga inicial.
     */
    function init() {
      ensureAdminButton()

      const saved = localStorage.getItem(LS_KEY)
      const url = saved || defaultCsv
      if (elInput) elInput.value = url || ''

      if (url) loadFrom(url)

      const btnTest = document.getElementById('ng-btn-test')
      const btnSave = document.getElementById('ng-btn-save')

      btnTest?.addEventListener('click', () => {
        const v = (elInput?.value || '').trim()
        if (!v) { elMsg.textContent = 'Peg√° una URL de Google Sheets (CSV).'; return }
        loadFrom(v)
      })

      btnSave?.addEventListener('click', () => {
        const v = (elInput?.value || '').trim()
        if (!v) { elMsg.textContent = 'Peg√° una URL de Google Sheets (CSV).'; return }
        localStorage.setItem(LS_KEY, v)
        elMsg.classList.remove('ng-error')
        elMsg.classList.add('ng-hint')
        elMsg.textContent = 'Guardado en este navegador.'
        loadFrom(v)
      })
    }

    init()
  })()
</script>

  </body>
</html>
